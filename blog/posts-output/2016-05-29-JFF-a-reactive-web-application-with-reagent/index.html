<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en">
<head>
    <meta charset="utf-8"/>
    <title>The Analytic Bastard: JFF: a reactive web application with reagent, re-frame and datascript</title>
    <link rel="canonical" href="http://analyticbastard.github.io/blog/posts-output/2016-05-29-JFF-a-reactive-web-application-with-reagent/">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link href='http://fonts.googleapis.com/css?family=Alegreya:400italic,700italic,400,700' rel='stylesheet'
          type='text/css'>
    <link rel="stylesheet" href="//maxcdn.bootstrapcdn.com/bootstrap/3.3.0/css/bootstrap.min.css">
    <link href="//maxcdn.bootstrapcdn.com/font-awesome/4.2.0/css/font-awesome.min.css" rel="stylesheet">
    <link rel="stylesheet" href="//cdnjs.cloudflare.com/ajax/libs/highlight.js/8.1/styles/default.min.css">
    <link href="/blog/css/screen.css" rel="stylesheet" type="text/css" />
</head>
<body>


<nav class="navbar navbar-default">
    <div class="container">
        <div class="navbar-header">
            <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar" aria-expanded="false" aria-controls="navbar">
                <span class="sr-only">Toggle navigation</span>
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
            </button>
            <a class="navbar-brand" href="/blog/">The Analytic Bastard</a>
        </div>
        <div id="navbar" class="navbar-collapse collapse">
            <ul class="nav navbar-nav navbar-right">
                <li ><a href="/blog/">Home</a></li>
                <li
                ><a href="/blog/archives/">Archives</a></li>
                
                <li
                >
                <a href="/blog/pages-output/about/">About</a>
                </li>
                
                <li><a href="/blog/feed.xml">RSS</a></li>
            </ul>
        </div><!--/.nav-collapse -->
    </div><!--/.container-fluid -->
</nav>


<div class="container">


    <div class="row">
        <div class="col-lg-9">
            <div id="content">
                
<div id="post">
    <div class="post-header">
    <div id="post-meta" class="row">
        <div class="col-lg-6">May 29, 2016</div>
        
    </div>
    <h2>JFF: a reactive web application with reagent, re-frame and datascript</h2>
</div>
<div>
    
    <p>Essensys, the last company I worked for in London, use to do something called Junk Food Friday, which, as you can guess, implies that each friday, one of us would order food for everybody else, be it pizza, burgers, Mexican, you name it. The process used to be a mess, with the organizer receiving emails with the requests, having an Excel sheet to organize him/herself, etc. That is why I developed the JFF app, which was an update from the coffee app (which was aimed at getting coffee from the local coffee shop, essentially the same use case).</p><p>I decided to give the new cool Clojure(Script) technologies a go and I was quite impressed (coming from working only with Reagent, Figwheel and a little bit of Datascript). Re-frame really adds value by providing a controller and a better model than just bare reagent atoms.</p><p>Since the web app shows all the updated content from the server, I figured out the communication system was the same than an chat system but, in this case, the message is the state change induced by any of the clients. So, the design is as follows:</p><ul><li>Datascript database in both the server and the client. The client'sDB is a reflection of the state of the server DB.</li><li>core.async maintains a general channel, a client channel (per client)and a listening channel which taps the general channel and redistributesany message generated by any client to all of the clients. Messagesare valid Datascript EDN. The client channel is connected to a websocket.</li><li>When the Datascript EDN is received by the client, it is transacted intothe local in-browser Datascript database. Changes in the database arelinked to re-frame subscriptions via declarative query functions,whose change (upon DB change) generate data that triggers a reagentcomponent refresh.</li></ul><p>Perhaps this is best seen as a diagram</p><p><img src="/blog/img/JFF.svg" alt="Apple Inc. price" /></p><p>Although you can see arrows in the previous diagrams, no specific calls are made to each of the components. In the client, whenever the user initiates a change, usually with the ```on-click``` handler of the web component, the re-frame handler generates the corresponding Datascript temporary transaction data according to the latest state (this means generating temporary IDs for the potentially new entitities), which will be a reflection of the server state.</p><p>That is sent via a core.async channel (ClojureScript version) which is attached to a websocket (Chord library, which directly returns a core.async channel).</p><p>On the server, there are three type of channels:</p><ul><li>One websocket channel per client</li><li>One general channel</li><li>One channel tapping the general channel per client</li></ul><p>The first receives transaction data from its client and sends it permanent transaction data once the server has transacted the data into its own DB. The general channel gets permanent data that has just transacted into the server's DB which is distributed to each of the tapping channels. When the program gets the data from the tapping channels, it writes it back to the client channel it is handling, as mentioned at the beginning of the paragraph.</p><p>The most important clojure function is the following</p><pre><code class="clojure">&#40;defn ws-handler &#91;{:keys &#91;ws-channel&#93; :as req} {:keys &#91;chat-ch chat-mult&#93;}&#93;
  &#40;let &#91;tapped-ch &#40;a/chan&#41;
        conn &#40;:conn @app-state&#41;
        init-tx   &#40;mapv &#40;comp op-eav datom-&gt;vec&#41; &#40;d/datoms &#40;d/db conn&#41; :eavt&#41;&#41;&#93;
    &#40;a/tap chat-mult tapped-ch&#41;
    &#40;println &#40;format &quot;Opened connection from %s.&quot;
                     &#40;:remote-addr req&#41;&#41;&#41;
    &#40;go
      &#40;when &#40;not-empty init-tx&#41;
        &#40;send! ws-channel init-tx&#41;&#41;
      &#40;loop &#91;&#93;
        &#40;a/alt!
          tapped-ch &#40;&#91;message&#93; &#40;if message
                                 &#40;do
                                   &#40;respond-to-tapped-ch ws-channel message&#41;
                                   &#40;recur&#41;&#41;
                                 &#40;do
                                   &#40;println &quot;NO msg&quot;&#41;
                                   &#40;a/close! ws-channel&#41;&#41;&#41;&#41;

          ws-channel &#40;&#91;ws-message&#93; &#40;if ws-message
                                     &#40;do &#40;respond-server-channel chat-ch ws-message&#41;
                                         &#40;recur&#41;&#41;
                                     &#40;do
                                       &#40;println &quot;Exiting&quot;&#41;
                                       &#40;a/untap chat-mult tapped-ch&#41;&#41;&#41;&#41;
          &#41;&#41;&#41;&#41;&#41;
</code></pre><p>Where you can identify ws-channel as the client websocket channel, chat-ch (and its multiplexed version chat-multi) as the general channel and ```tapped-channel``` as the channel tapping the general channel.</p><p>Whenever ws-channel has a message, we transact it into the DB via the function respond-server-channel,</p><pre><code class="clojure">&#40;defn respond-server-channel &#91;chat-ch ws-message&#93;
  &#40;let &#91;message &#40;:message ws-message&#41;
        conn    &#40;:conn @app-state&#41;
        tx-data &#40;:datascript-tx message&#41;
        tx-data &#40;when tx-data
                  &#40;:tx-data &#40;d/transact! conn tx-data&#41;&#41;&#41;
        &#93;
    &#40;if tx-data
      &#40;do
        &#40;spit session-file-name @conn&#41;
        &#40;send! chat-ch &#40;mapv &#40;comp op-eav datom-&gt;vec&#41; tx-data&#41;&#41;&#41;
      &#40;do
        &#40;process-command message&#41;
        &#40;send! chat-ch message&#41;&#41;&#41;
    &#41;&#41;
</code></pre><p>This function will also put the resulting permanent transaction into the general channel. The tapping channels will pick this up and then send the permanent transactions to the clients via ws-channel. Notice that we create all of these channels upon client connection, except the general channel, which is created on server startup.</p><pre><code class="clojure">        chat-ch &#40;a/chan&#41;
        chat-mult &#40;a/mult chat-ch&#41;
</code></pre><p>At the client side we can divide the app into three sections: the model, the view and the controller. The view is seamlessly handled by reagent. The model and the controller are re-frame. The controller is made of handlers which are connected to the DOM components via the on-click callback, and that are of this form</p><pre><code class="clojure">&#40;register-handler :pre-add-section
                  &#40;fn &#91;db &#91;&#95; section-name&#93;&#93;
                    &#40;let &#91;server-ch &#40;:server-ch db&#41;
                          tx-data   &#91;{:db/id -1 :section/name section-name}&#93;&#93;
                      &#40;send-datascript-tx! server-ch tx-data&#41;
                      &#41;
                    db&#41;&#41;
</code></pre><p>As we can see, it is the controller the one building the temporary transaction data (see the negative id) and send it to the server.</p><p>The model is made of subscriptions which contain queries for the local datascript DB. When we receive data from the websocket channel on the client, we insert it into the local, in-browser DB. The change on the DB triggers a change in the subscription DB query value.</p><pre><code class="clojure">&#40;register-sub :post-user-names
              &#40;fn &#91;db &#95;&#93;
                &#40;query-&gt;reaction db
                                 '&#91;:find &#91;?name ...&#93;
                                   :where
                                   &#91;&#95; :user/name ?name&#93;
                                   &#93;&#41;&#41;&#41;
</code></pre><p>This change, then, triggers a refresh in the reagent components (the view) that have subscribed to it, such as this one</p><pre><code class="clojure">&#40;defn user-selection-component &#91;user-name&#93;
  &#40;let &#91;choice-names @&#40;subscribe &#91;:post-user-choices user-name&#93;&#41;&#93;
    &#91;:li.list-group-item
     &#91;:div
      user-name
      &#40;vec
        &#40;concat &#91;:div&#93;
                &#40;for &#91;choice-name choice-names&#93;
                  &#91;:div choice-name&#93;&#41;&#41;&#41;&#93;&#93;&#41;&#41;
</code></pre><p>The source code is fully available on <a href='https://github.com/analyticbastard/jff'>Github</a>.</p>
</div>

<div id="post-tags">
    <b>Tags: </b>
    
    <a href="/blog/tags-output/Clojure/">Clojure</a>
    
    <a href="/blog/tags-output/Tools/">Tools</a>
    
    <a href="/blog/tags-output/Programming/">Programming</a>
    
</div>


    <div id="prev-next">
        
        <a href="/blog/posts-output/2016-06-09-building-an-automated-trading-system/">&laquo; Building a Machine Learning-based automated trading system</a>
        
        
        <a class="right" href="/blog/posts-output/2016-03-30-new-blog-with-cryogen/">New blog using Cryogen &raquo;</a>
        
    </div>

    
    <div id="disqus_thread"></div>
    <script type="text/javascript">
        (function() {
            var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
            dsq.src = '//theanalyticbastard.disqus.com/embed.js';
            (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
        })();
    </script>
    


</div>

            </div>
        </div>

        <div class="col-md-3">
            <div id="sidebar">
                <!-- <h3>Links</h3>
                <ul id="links">
                    
                    <li><a href="/blog/pages-output/c/">C, C++ and others</a></li>
                    
                    <li><a href="/blog/pages-output/clojure/">Clojure</a></li>
                    
                    <li><a href="/blog/pages-output/courses/">Courses</a></li>
                    
                    <li><a href="/blog/pages-output/databases/">Databases</a></li>
                    
                    <li><a href="/blog/pages-output/experience/">experience</a></li>
                    
                    <li><a href="/blog/pages-output/git/">Git</a></li>
                    
                    <li><a href="/blog/pages-output/intellij/">IntelliJ</a></li>
                    
                    <li><a href="/blog/pages-output/java/">Java</a></li>
                    
                    <li><a href="/blog/pages-output/lein/">Leiningen and Maven</a></li>
                    
                    <li><a href="/blog/pages-output/matlab/">Matlab and R</a></li>
                    
                    <li><a href="/blog/pages-output/mobile/">Mobile</a></li>
                    
                    <li><a href="/blog/pages-output/python/">Python</a></li>
                    
                    <li><a href="/blog/pages-output/scientific/">Scientific Libraries</a></li>
                    
                </ul> -->
                
                <div id="recent">
                    <h3>Recent Posts</h3>
                    <ul>
                        
                        <li><a href="/blog/posts-output/2016-07-08-mysql-fulltext/">MySQL full text search: a simple example</a></li>
                        
                        <li><a href="/blog/posts-output/2016-07-05-mysql-gis/">MySQL GIS capabilities: query geographical locations simple example</a></li>
                        
                        <li><a href="/blog/posts-output/2016-07-03-cant-wait-for-java-repl/">Interactive, high throughput, low turnaround development in the JVM: my setup</a></li>
                        
                        <li><a href="/blog/posts-output/2016-06-27-Lifestyle-supplements-nootropics/">Oxidative stress: its causes, its consequences and its solution</a></li>
                        
                        <li><a href="/blog/posts-output/2016-06-09-building-an-automated-trading-system/">Building a Machine Learning-based automated trading system</a></li>
                        
                    </ul>
                </div>
                
                
                <div id="tags">
                    <h3>Tags</h3>
                    <ul>
                        
                        <li><a href="/blog/tags-output/Matlab/">Matlab</a></li>
                        
                        <li><a href="/blog/tags-output/Mathematics/">Mathematics</a></li>
                        
                        <li><a href="/blog/tags-output/Python/">Python</a></li>
                        
                        <li><a href="/blog/tags-output/Databases/">Databases</a></li>
                        
                        <li><a href="/blog/tags-output/Clojure/">Clojure</a></li>
                        
                        <li><a href="/blog/tags-output/Brainteasers/">Brainteasers</a></li>
                        
                        <li><a href="/blog/tags-output/MySQL/">MySQL</a></li>
                        
                        <li><a href="/blog/tags-output/Nootropics &amp; Supplements/">Nootropics &amp; Supplements</a></li>
                        
                        <li><a href="/blog/tags-output/Tools/">Tools</a></li>
                        
                        <li><a href="/blog/tags-output/Git/">Git</a></li>
                        
                        <li><a href="/blog/tags-output/Statistics/">Statistics</a></li>
                        
                        <li><a href="/blog/tags-output/Programming/">Programming</a></li>
                        
                        <li><a href="/blog/tags-output/Java/">Java</a></li>
                        
                        <li><a href="/blog/tags-output/Hackintosh/">Hackintosh</a></li>
                        
                        <li><a href="/blog/tags-output/Software Development/">Software Development</a></li>
                        
                        <li><a href="/blog/tags-output/Machine Learning/">Machine Learning</a></li>
                        
                    </ul>
                </div>
                

                <script type="text/javascript" src="//rc.revolvermaps.com/0/0/6.js?i=2j1s8v947td&amp;m=7&amp;s=320&amp;c=e63100&amp;cr1=ffffff&amp;f=arial&amp;l=0&amp;bv=90&amp;lx=-420&amp;ly=420&amp;hi=20&amp;he=7&amp;hc=a8ddff&amp;rs=80" async="async"></script>
            </div>
        </div>
    </div>
    <footer>Copyright &copy;  The Analytic Bastard
        <p style="text-align: center;">Powered by <a href="http://cryogenweb.org">Cryogen</a></p></footer>
</div>
<script src="//code.jquery.com/jquery-1.11.0.min.js"></script>
<script src="//maxcdn.bootstrapcdn.com/bootstrap/3.3.0/js/bootstrap.min.js"></script>
<script src="/blog/js/highlight.pack.js" type="text/javascript"></script>
<script>hljs.initHighlightingOnLoad();</script>
<script src="http://cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS_HTML" type="text/javascript"></script>
<script type="text/x-mathjax-config">
MathJax.Hub.Config({
  jax: ["input/TeX", "output/HTML-CSS"],
  tex2jax: {
    inlineMath: [ ['$', '$'] ],
    displayMath: [ ['$$', '$$']],
    processEscapes: true,
    skipTags: ['script', 'noscript', 'style', 'textarea', 'pre', 'code']
  },
  messageStyle: "none",
  "HTML-CSS": { preferredFont: "TeX", availableFonts: ["STIX","TeX"] }
});
</script>
<script>
    (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
                (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
            m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
    })(window,document,'script','https://www.google-analytics.com/analytics.js','ga');

    ga('create', 'UA-80059282-1', 'auto');
    ga('send', 'pageview');

</script>

</body>
</html>
